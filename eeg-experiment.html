<!DOCTYPE html>
<html>
  <head>
    <title>Card Betting Task</title>
    <script src=jspsych/jspsych.js></script>
    <script src=jspsych/plugin-html-keyboard-response.js></script>
    <script src=jspsych/plugin-image-keyboard-response.js></script>
    <script src=jspsych/plugin-preload.js></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css"/>
  </head>

  <style>
    p {color: #5A5A5A; font-size: 20px;}
    .RED {color: red; font-weight: bold;}
    .BLACK {color: black; font-weight: bold;}
    .fixation {color: #5A5A5A; font-size: 60px; font-weight: bold;}
    .choice_container div {width: 200px; height: 100px; font-size: 60px;}
    .show_choice_container
    {
      position: absolute;
      display: flex;
      top: 50%;
      left: 50%;
      margin-top: -75px;
      margin-left: -200px;
      justify-content: center;
      width: 400px;
      height: 150px;
    }
    .card_deck
    {
        margin: 0;
        position: fixed;
        display: flex;
        justify-content: center;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        width: 400px;
        height: 400px;
        border-radius: 100%;
    }
    .card
    {
        position: absolute;
        top: 50%;
        width: 80px;
        height: 100px;
        background: grey;
        border-radius: 10px;
        border: 7px solid #5A5A5A;
    }
    .deg-0 {transform: translateY(-200px)}
    .deg-72 {transform: rotate(72deg) translateY(-150px) rotate(-72deg) translateY(-50px)}
    .deg-144 {transform: rotate(144deg) translateY(-150px) rotate(-144deg) translateY(-50px)}
    .deg-216 {transform: rotate(216deg) translateY(-150px) rotate(-216deg) translateY(-50px)}
    .deg-288 {transform: rotate(288deg) translateY(-150px) rotate(-288deg) translateY(-50px)}
  </style>

  <body></body>

  <script>
    // Set up ======================================================================================================================
  
    /* initiate jsPsych trial */
    var jsPsych = initJsPsych
    ({
      on_finish: function()
      {jsPsych.data.displayData();}
    });

    /* declare global vars here */
    var TIMELINE = [];
    var trial_number = 1; // initialize trial number
    var money = 10; // initialize the money won
    var block_number = 1; // block number

    /* initialize color container 
    color[0] represent the color that participant bet on
    color[1] represent the other color */
    var color = [2];
    
    /* 16 card combinations */
    /**logic: 
     * the winning card combination listed all the possible outcome when the card that participants
     * picked (color[0]) is more than the color they did not pick (color[1]).
     * the losing card combination listed all the possible outcome when the card that participants
     * picked (color[0]) is less than the color they did not pick (color[1]).
     * 
     * 0 represent win result.
     * 1 represent lose result.
    */
    var win_card_comb =
    [ 
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[1], result: 0},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[0], result: 0},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[1], result: 0},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[1], result: 0},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[0], result: 0},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[1], result: 0},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[1], result: 0},
    ]

    var lose_card_comb =
    [ 
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[0], result: 1},
      {card1: ()=>color[0], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[1], result: 1},
      {card1: ()=>color[0], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[0], result: 1},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[0], card3: ()=>color[1], card4: ()=>color[1], card5: ()=>color[0], result: 1},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[0], card5: ()=>color[1], result: 1},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[0], card4: ()=>color[1], card5: ()=>color[0], result: 1},
      {card1: ()=>color[1], card2: ()=>color[1], card3: ()=>color[1], card4: ()=>color[0], card5: ()=>color[0], result: 1},
    ]

    var final_outcome = partition_array(shuffleOutcome(), 16); // array of arrays of all the card results 

    // functions ====================================================================================================================
    
    /* generate random card sequence */
    function cardColorSeqGen()
    {
      var colorArr = [5];

      for (var i=0; i<5; i++)
      {colorArr[i] = Math.round(Math.random());}

      return colorArr;
    };
    
     /** create a shuffled array that contain the outcome info of all 80 trials,
     * each time it will generate an equal number of win and lose trials for each of the 16 card combination sequence
     * 16 card combs will appear twice in each of the 40 win or lose trials,
     * the first 8 card combs will appear one more time (not sure if we want to randomize this part)
     **/
    function makeItForty(comb){  // helper function: duplicate the array and append the first half of the array to the resulting array
      var comb_copy = comb.concat(comb);
      var half_copy = comb.slice(0, (comb.length/2));
      var forty_array = comb_copy.concat(half_copy);

      return forty_array
    }

    function shuffleOutcome(){ // create and shuffle card outcomes
      var outcome = [80];
      var all_wcard_comb = makeItForty(win_card_comb);
      var all_lcard_comb = makeItForty(lose_card_comb);

      for (var i=0; i<40; i++) // looping to put all the possible outcome into an array
      {
        outcome [i] = all_wcard_comb[i];
      }
      for (var i=40 ; i<80; i++)
      {
        outcome [i] = all_lcard_comb[(i-40)];
      }

      // shuffle the determined outcomes
      var shuffled_outcome = jsPsych.randomization.shuffle(outcome); 
      return shuffled_outcome;
    }

    function partition_array(a, n){ // partition an array a into group of size n
      const res = [];
      for(let i = 0; i < a.length; i++) {
        if(i % n == 0){
         res.push([a[i]]); // start a new array
      }
      else{
         res[res.length-1].push(a[i]); // push the current value into the array
      };
    };
    return res;
    }
    
    /* Dynamic parameters helper function */
    function callTrial (){ // call trial number 
      return trial_number;
    }
    
    function callMoney() { // call money
      return money;
    }
    
    function callBlock(){ // call block number
      return block_number;
    }
    
    function roundTo(n, place) {    
      return +(Math.round(n + "e+" + place) + "e-" + place);
    }
    
    // Reusable trial blocks ========================================================================================================
    
    /* trial title card */
    var trial_title =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function()
      {
        var html = `
        <p>Trial: <strong>${callTrial()}</strong></p>
        <br>
        <p>Place your bet on the next slide.</p>
        `;
        return html;
      },
      choices: "NO_KEYS",
      trial_duration: 3000
    }

    /* choice trial */
    var choice =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus:
      `
        <div class="choice_container" style="position: relative; margin: auto; display: flex; justify-content: space-between;">
          <div class="RED" style="text-align: right;">RED</div>
          <div class="fixation">+</div>
          <div class="BLACK" style="text-align: left;">BLACK</div>
        </div>
      `,
      choices: ['ArrowLeft', 'ArrowRight'], //left -> red, right -> black
      data: {task: 'response', red: 'ArrowLeft'},
      on_finish: function(data)
      {
        data.color = jsPsych.pluginAPI.compareKeys(data.response, data.red) ? 'red' : 'black';
        if (data.color == 'red'){
          color[0] = 'red';
          color[1] = 'black';
        }
        else {
          color[0] = 'black';
          color[1] = 'red';
        }
      }
    }
    
    /* show choice trial */
    var show_choice =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function()
      {
        var color = jsPsych.data.get().filter({task: 'response'}).last(1).select('color').values[0];
        console.log(color);
        var retHtml;

        if (color == 'red')
        {
          retHtml = `
          <div class="show_choice_container">
          <p>Chosen option: <span class="RED">RED</span></p>
          <div class="card" style="background: red;"></div>
          </div>
          `;
        }
        else
        {
          retHtml = `
          <div class="show_choice_container">
          <p>Chosen option: <span class="BLACK">BLACK</span></p>
          <div class="card" style="background: black;"></div>
          </div>
          `;
        }

        return retHtml;
      },
      choices: "NO_KEYS",
      trial_duration: 2000
    }
    
    /* card reveal sequence */
    var reveal_seq = [
      {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: function()
          {
            var html = 
            `<div class ="card_deck">
              <div class ="card deg-0" style="background: grey"></div>
              <div class ="card deg-72" style="background: grey"></div>
              <div class ="card deg-144" style="background: grey"></div>
              <div class ="card deg-216" style="background: grey"></div>
              <div class ="card deg-288" style="background: grey"></div>
            </div>
            <div class="fixation">+</div>`;
          return html;
          },
          choices: "NO_KEYS",
          trial_duration: 2000
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: function()
          {
            var html = 
            `<div class ="card_deck">
              <div class ="card deg-0" style="background: ${jsPsych.timelineVariable('card1')()}"></div>
              <div class ="card deg-72" style="background: grey"></div>
              <div class ="card deg-144" style="background: grey"></div>
              <div class ="card deg-216" style="background: grey"></div>
              <div class ="card deg-288" style="background: grey"></div>
            </div>
            <div class="fixation">+</div>`;
            return html;
          },
          choices: "NO_KEYS",
          trial_duration: 3000
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: function()
          {
            var html = 
            `<div class ="card_deck">
              <div class ="card deg-0" style="background: ${jsPsych.timelineVariable('card1')()}"></div>
              <div class ="card deg-72" style="background: ${jsPsych.timelineVariable('card2')()}"></div>
              <div class ="card deg-144" style="background: grey"></div>
              <div class ="card deg-216" style="background: grey"></div>
              <div class ="card deg-288" style="background: grey"></div>
            </div>
            <div class="fixation">+</div>`;
            return html;
          },
          choices: "NO_KEYS",
          trial_duration: 3000
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus:function()
          {
            var html = 
            `<div class ="card_deck">
              <div class ="card deg-0" style="background: ${jsPsych.timelineVariable('card1')()}"></div>
              <div class ="card deg-72" style="background: ${jsPsych.timelineVariable('card2')()}"></div>
              <div class ="card deg-144" style="background: ${jsPsych.timelineVariable('card3')()}"></div>
              <div class ="card deg-216" style="background: grey"></div>
              <div class ="card deg-288" style="background: grey"></div>
            </div>
            <div class="fixation">+</div>`;
            return html;
          },
          choices: "NO_KEYS",
          trial_duration: 3000
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: function()
          {
            var html = 
            `<div class ="card_deck">
              <div class ="card deg-0" style="background: ${jsPsych.timelineVariable('card1')()}"></div>
              <div class ="card deg-72" style="background: ${jsPsych.timelineVariable('card2')()}"></div>
              <div class ="card deg-144" style="background: ${jsPsych.timelineVariable('card3')()}"></div>
              <div class ="card deg-216" style="background: ${jsPsych.timelineVariable('card4')()}"></div>
              <div class ="card deg-288" style="background: grey"></div>
            </div>
            <div class="fixation">+</div>`;
            return html;
          },
          choices: "NO_KEYS",
          trial_duration: 3000
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: function()
          {
            var html = 
            `<div class ="card_deck">
              <div class ="card deg-0" style="background: ${jsPsych.timelineVariable('card1')()}"></div>
              <div class ="card deg-72" style="background: ${jsPsych.timelineVariable('card2')()}"></div>
              <div class ="card deg-144" style="background: ${jsPsych.timelineVariable('card3')()}"></div>
              <div class ="card deg-216" style="background: ${jsPsych.timelineVariable('card4')()}"></div>
              <div class ="card deg-288" style="background: ${jsPsych.timelineVariable('card5')()}"></div>
            </div>
            <div class="fixation">+</div>`;
            return html;
          },
          choices: "NO_KEYS",
          trial_duration: 3000
        }
      ]
     
    // Welcome + practice trials ====================================================================================================
    
    /* welcome instructions */
    var welcome_instructions =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus:
      `
        <p>Welcome and thank you for participating in this study!</p>
        <br>
        <p>In each trial, you will predict whether there will be more
            <span class="RED">RED</span> or
            <span class="BLACK">BLACK</span> cards.</p>
        <p>Afterwards, on the next slide, a deck of 5 cards will appear.</p>
        <br>
        <p>Each card has a 50% chance of appearing as either color.</p>
        <p>If you correctly predicted the color of most of the cards, you win the round.</p>
        <p>Otherwise, you lose the round.</p>
        <br>
        <p>The next few slides will serve as a tutorial.</p>
        <br>
        <p>Press any key to move on to the next slide.</p>
      `,
      post_trial_gap: 100
    };

    /* practice guided round instructions */
    var practice_guided_instructions =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus:
      `
        <p>We will now go through <strong>2</strong> practice rounds.</p>
        <p>On the next slide, you will see the words
          “<span class="RED">RED</span>” and
          “<span class="BLACK">BLACK</span>”.</p>
        <p>Click ← on your keyboard to choose
          “<span class="RED">RED</span>” or → to choose
          “<span class="BLACK">BLACK</span>”.</p>
        <br>
        <p>Please try to stay focused on the fixation cross in the center and reduce blinking during trials.</p>
        <p>Press any key to move on to the next slide.</p>
      `,
      post_trial_gap: 100
    };

    /* practice guided round post-choice instruction */
    var practice_guided_post_choice_instructions =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus:
      `
        <p>Great!</p>
        <p>On the following slide, you will see a deck of 5 cards.</p>
        <p>The color of each card will be automatically revealed one by one.</p>
        <br>
        <p>If more cards in the deck are in your chosen color than the other color, you win this round.</p>
        <p>Otherwise, you lose this round.</p>
        <br>
        <p>Press any key to move on to the next slide.</p>
      `,
      post_trial_gap: 100
    };

    /* practice guided round card reveal */
    var practice_guided_card_reveal =
    {
      timeline: reveal_seq,
      timeline_variables :[{card1: ()=>"red", card2: ()=>"red", card3: ()=>"red", card4: ()=>"black", card5: ()=>"black"}],
    };

    /* practice guided round end instructions */
    var practice_guided_end_instructions =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function()
      {
        var practiceResponse0 = jsPsych.data.get().filter({task: 'response'}).last(1).select('color').values[0];
        var retHtml;

        if (practiceResponse0 == 'red')
        {
          retHtml =
          `
          <p>Well done!</p>
          <br>
          <p>The next practice trial will be identical to the previous, but you will not be given any instructions.</p>
          <br>
          <p>Please stay focused on the fixation point “<strong>+</strong>” at the center and blink as little as possible.</p>
          `;
        }
        else
        {
          retHtml =
          `
          <p>Whoops, better luck next time!</p>
          <br>
          <p>The next practice trial will be identical to the previous, but you will not be given any instructions.</p>
          <br>
          <p>Please stay focused on the fixation point “<strong>+</strong>” at the center and blink as little as possible.</p>
          `;
        }
        return retHtml;
      },
      post_trial_gap: 100
    };

            /* 2nd practice trial card reveal */
            var practice_2_card_reveal =
    {
      timeline: reveal_seq,
      timeline_variables :[{card1: ()=>"black", card2: ()=>"black", card3: ()=>"red", card4: ()=>"red", card5: ()=>"black"}],
    };

      /* practice trial 2 end instructions */
      var practice_2_end_instructions =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function()
      {
        var practiceResponse0 = jsPsych.data.get().filter({task: 'response'}).last(1).select('color').values[0];
        var retHtml;

        if (practiceResponse0 == 'black')
        {
          retHtml =
          `
          <p>Well done!</p>
          <br>
          <p>You will now begin with the real trials.</p>
          `;
        }
        else
        {
          retHtml =
          `
          <p>Whoops, better luck next time!</p>
          <br>
          <p>You will now begin with the real trials.</p>
          `;
        }
        return retHtml;
      },
      post_trial_gap: 100
    };

    /* 2 practice trials */
    var practice_procedure =
    {
      timeline:
      [
        practice_guided_instructions,
        choice,
        show_choice,
        practice_guided_post_choice_instructions,
        practice_guided_card_reveal,
        practice_guided_end_instructions,
      ]
    }

    var practice_procedure_2 = 
    {
      timeline:
      [
        choice,
        show_choice,
        practice_2_card_reveal,
        practice_2_end_instructions,
      ]
    }

    //  test trials blocks ==========================================================================================================
    
    /* card reveal sequence */
    var card_reveal =
    {
      timeline: reveal_seq
    };

    /* result page */
    /** can not update money and trial_number **/
    var result_page = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        trial_number++;
        if (jsPsych.timelineVariable('result') == 0){
          money += 0.2;
          return `
          <div class="info_container" style="position: relative; margin: auto; display: flex; justify-content: space-between;">
            <div class="trial" style="text-align: center;">
              <p>Won 20 cents!</p></div>
              <p>Your total winnings were $${money}. </p> 
          </div>`
        }
        if (jsPsych.timelineVariable('result') == 1){
          return `
          <div class="info_container" style="position: relative; margin: auto; display: flex; justify-content: space-between;">
            <div class="trial" style="text-align: center;">
              <p>Lost this Round.</p></div>
              <p>Your total winnings were $${money}. </p>
          </div>`
        };
      },
      choices: "NO_KEYS",
      trial_duration: 2000,
    }

    /* test run timeline */
    var test_proc = {
      timeline: [
        trial_title,
        choice,
        show_choice,
        card_reveal,
        result_page,
      ],
      timeline_variables: final_outcome[callBlock()],
    }

    // Block timeline ========================================================================================================

    
    // [TUT CODE] to show at end of trials. gives info on how participant did.
    var debrief_block =
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        var trials = jsPsych.data.get().filter({task: 'response'}); // getting # of response trials
        var correct_trials = trials.filter({correct: true}); // filtering for correct for # correct answers
        var accuracy = Math.round(correct_trials.count() / trials.count() * 100); // proportion
        var rt = Math.round(correct_trials.select('rt').mean()); // mean reaction time

        return `<p>You responded correctly on ${accuracy}% of the trials.</p>
      <p>Your average response time was ${rt}ms.</p>
      <p>Press any key to complete the experiment. Thank you!</p>`;
      }
    };

    // Timeline push and run --------------------------------------------------------------------------------------------------------
    TIMELINE.push(welcome_instructions);
    TIMELINE.push(practice_procedure);
    TIMELINE.push(practice_procedure_2)
    TIMELINE.push(test_proc);

    //timeline.push(debrief_block);
    jsPsych.run(TIMELINE); // run it all!
  </script>
</html>